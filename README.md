# [Air001_BedProbe](https://github.com/aoangen/Air001_BedProbe)

[获取硬件资料](https://oshwhub.com/aoang/air001_bedprobe)

3D打印机压力热床，主控MCU使用合宙Air001，可以使用HX71708、CS1237两种AD转换芯片

电路简单易于修改，可以很容易嵌入各种其它主板或项目电路中



> 芯片可选数据速率
> 
> HX71708 **10、20、80、320**
> 
> CS1237 **10、40、640、1280**



![截图_2023-10-23_14-26-45.png](https://s2.loli.net/2023/10/23/9xsdfjF1c4yCkgL.png)



测试条件：CS1237 1280Hz，5mm/s速度，皮带Z 80:20减速比，触发重量150g
连续10次重复精度测试结果：

| Range  | Deviation |
| ------ | --------- |
| 0.0025 | 0.001146  |
| 0.0025 | 0.001146  |
| 0.0050 | 0.001581  |
| 0.0050 | 0.001581  |
| 0.0025 | 0.001000  |
| 0.0075 | 0.001871  |
| 0.0050 | 0.002000  |
| 0.0050 | 0.001658  |
| 0.0050 | 0.001581  |
| 0.0050 | 0.001346  |

klipper官方建议调平探针的重复精度范围在0.025以内，如果使用HX711，数据速率最高80Hz的情况下，只能降低速度勉强达到要求，高采样率的HX71708和CS1237可以显著提高重复精度以获得更好的探测数据

> 如果测试结果显示范围(range)值大于25微米（0.025毫米），那么探针不满足典型的床面调平流程的精确度要求。可以尝试调整探测速度和/或探测起点高度以提高探头的重复性。

![截图_2023-10-23_15-47-28.png](https://s2.loli.net/2023/10/23/CWjFhsDMmn9zIQR.png)
对比HX71708 80和320Hz的数据间隔，还有CS1237的数据间隔

## 下载说明

需要自备串口下载器，连接预留的串口排针插座进行下载

根据合宙官方教程配置开发环境[Air001基于Arduino的用户手册](https://wiki.luatos.com/chips/air001/Air001-Arduino.html)

> [重点]下载时将主频设置为48MHz

![下载配置选项](https://s2.loli.net/2023/11/16/KUfAPc3ygHFEYbG.png)

## 程序说明

> 程序都来自ChatGPT4编写

* 校准修改 ` const float calibration_factor = 209.5;`
此值是一个校准因子，用于将 ADC（模数转换器）的读数转换为实际的重量，不同传感器结果不同，需要自行测试修改得到准确的称重结果。
* 开启串口输出` bool serialOutput = false;`设置为true，则串口始终实时输出当前重量读数，降低采样率可以得到更精准的重量` SPEED_1280`,使用已知重量物品称重，观察读数，修改校准因子，直到读数接近所称重物品的实际重量。
  > [重点]air001的性能不足以在640Hz以上采样率开启串口稳定运行，仅在调试时降低采样率使用，高采样率下务必关闭
* ` const float thresholds[] = { 50.0, 150.0, 300.0 };  `自定义触发阈值重量，boot按键在运行中可以用于切换。


***

HX711库不支持HX71708修改数据速率，HX71708只有一个通道，增益固定，通过代码修改数据速率；而HX711通过硬件修改速率，代码修改增益，所以需要修改hx711.cpp的库文件(给出的程序默认已修改好，可直接编译)
![截图_2023-10-23_15-59-30.png](https://s2.loli.net/2023/10/23/RGyBl7eSj8WkuN3.png)
![RTKw9UnKRZjVjXnvv6nNOltJxF7OJTKdrTqowNbj.png](https://s2.loli.net/2023/10/23/gKIcJoqEwVU5Pxk.png)
代码中scale.set_gain(64);设置增益，再把对应增益在,cpp库文件中的脉冲数改为4，即可实现对数据速率的控制

HX711程序以绝对压力值判断，压力值超过阈值即触发，每隔一段时间读数归零

CS1237以相对压力值判断，以实现不归零动态检测压力突变，实时压力值>参考值+阈值触发，参考值每隔一段时间更新一次，缓慢增长的重量到了阈值不会导致触发

都使用Boot键切换代码中的预设阈值

输出两个相反的高低电平信号，短接跳线处选择

建议使用CS1237，相对价格更低、性能更好，代码调试功能更丰富
